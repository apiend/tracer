let e={reportUrl:"http://localhost:7002",reportUrlMultiple:"",maxCacheLength:20,isPost:!1,token:"",appVersion:"1.0.0",environment:"prod",outtime:300,enableSPA:!0,autoSendPv:!0,isPage:!0,isAjax:!1,isResource:!1,isError:!0,isRecord:!1,isCountStayTime:!0,isBehavior:!1,ignore:{ignoreErrors:[],ignoreUrls:[],ignorePvs:["404"],ignoreResources:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"],ignoreBehaviorEles:[]},behavior:{console:["debug","error"],click:!0},maxLength:100,Vue:"",user:{},offlineTime:6e5,sendMill:3e4};function t(t){const n=Object.assign(Object.assign({},e.ignore),t.ignore);e=Object.assign(Object.assign(Object.assign({},e),t),{ignore:n})}function n(t){return t&&e[t]?e[t]:{}}const o=function(){};function r(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");n-- >0;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var a=0;a<8;a++)o.splice(3*a+2,0,r[a]);return o.join("")}function a(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function i(e,t){var n=0,o=e.length;if(function(e,t){var n=Object.prototype.toString.call(e).substring(8).replace("]","");return t?n===t:n}(e,"Array"))for(;n<o&&!1!==t.call(e[n],e[n],n);n++);else for(var r in e)if(!1===t.call(e[r],e[r],r))break;return e}const s=function(e,t,n){window.addEventListener?window.addEventListener(e,function o(r){n&&window.removeEventListener(e,o,!0),t.call(this,r)},!0):window.attachEvent&&window.attachEvent("on"+e,function o(r){n&&window.detachEvent("on"+e,o),t.call(this,r)})},c=function(e,t){return t?(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t),this):this},d=function(e,t,n,o){return e.addEventListener?e.addEventListener(t,function r(a){o&&e.removeEventListener(t,r,!1),n.call(this,a)},!1):e.attachEvent&&e.attachEvent("on"+t,function r(a){o&&e.detachEvent("on"+t,r),n.call(this,a)}),this},l=function(e){return(e?u(e.replace(/^#\/?/,"")):"")||"[index]"},u=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},p=function(e){return function(){return e+"() { [native code] }"}},g=function(){var e="object"==typeof console?console.warn:o;try{var t={warn:e};t.warn.call(t)}catch(e){return o}return e}(),f=function(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)},h=function(e){var t=e.split("::");return t.length>1?{group:t[0],key:t[1]}:{group:"default_group",key:t[0]}},v=function(e,t){return e.reduce(function(e,n,o){return t(n,o)?o:e},-1)},m=function(){return navigator.userAgent.indexOf("Edge")>-1},w=self!=top,b=()=>{const e=new WeakSet;return(t,n)=>{if("object"==typeof n&&null!==n){if(e.has(n))return;e.add(n)}return n}},y=localStorage.getItem("bombay-cache")?JSON.parse(localStorage.getItem("bombay-cache")):[];let j={lastTime:Date.now(),page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,reportCache:y,cssInserted:!1};function O(e,t){"error"===e&&j._health.errcount++,"api"===e&&t&&j._health.apisucc++,"api"!==e||t||j._health.apifail++}var E="2.1.6";function L(){const t=function(){let e,t=navigator.userAgent,n={},o=t.match(/MicroMessenger.*?(?= )/);o&&o.length>0&&(n.wechat=o[0]);(t.includes("iPhone")||t.includes("iPad"))&&(t.includes("iPad")?n.deviceModel="iPad":n.deviceModel="iPhone",(o=t.match(/iPhone OS .*?(?= )/))&&o.length>0&&(n.deviceOs=o[0]),e="ios");t.includes("Android")&&((o=t.match(/Android.*; ?(.*(?= Build))/))&&o.length>1&&(n.deviceModel=o[1]),(o=t.match(/Android.*?(?=;)/))&&o.length>0&&(n.deviceOs=o[0]),e="Android");e||(n.deviceModel="pc",n.deviceOs="pc",n.wechat="other");return n}(),n=t.deviceModel+"|"+t.deviceOs+"|"+t.wechat;let o=navigator.connection;return{t:"",page:S(),hash:location.hash,v:`${E}`,token:e.token,e:e.environment,begin:(new Date).getTime(),uid:C(),sid:j.sid,sr:screen.width+"x"+screen.height,vp:T(),ct:o?o.effectiveType:"",device:n,ul:R(),o:A(encodeURIComponent(location.href)),user:JSON.stringify(e.user)}}function S(){return j.page?j.page:location.pathname.toLowerCase()}function C(){let e=localStorage.getItem("tracer_uid")||"";return e||(e=r(),localStorage.setItem("tracer_uid",e)),e}function R(){var e=navigator.language||navigator.userLanguage;return e=e.substr(0,2)}function T(){return(document.documentElement.clientWidth||document.body.clientWidth)+"x"+(document.documentElement.clientHeight||document.body.clientHeight)}function A(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}))}function x(t){return Array.isArray(t)?P(t):"res"===t.t?P(t):"error"===t.t?P(t):"behavior"===t.t?P(t):"health"===t.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?function(t){"object"==typeof t&&(t=a(t)),t=`${e.reportUrl}?${t}`,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(t):g("[arms] navigator.sendBeacon not surported")}(t):P(t),this}function P(t){if(Array.isArray(t))k(e.reportUrlMultiple,{behaviorList:t});else if(e.isPost){var n=t[t.t];delete t[t.t],k(`${e.reportUrl}?${a(t)}`,{[t.t]:n})}else(new Image).src=`${e.reportUrl}?${a(t)}`}function k(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){g("[tracer.js] Failed to log, POST请求失败")}else g("[tracer.js] Failed to log, 浏览器不支持XMLHttpRequest")}const _="bombayjs-circle-active",N="bombayjs-circle-css";const I=function(e){var t,n,o,r,a,i=[];if(!e||!e.tagName)return"";if(i.push(e.tagName.toLowerCase()),e.id&&i.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),a=0;a<n.length;a++)n[a].indexOf("active")<0&&i.push(".".concat(n[a]));var s=["type","name","title","alt"];for(a=0;a<s.length;a++)o=s[a],(r=e.getAttribute(o))&&i.push("[".concat(o,'="').concat(r,'"]'));return i.join("")},M=function(e){if(!e||1!==e.nodeType)return"";var t=[],n=0,o="";e.innerText&&t.push(`(${e.innerText.substr(0,50)})`);for(var r=e||null;r&&n++<5&&"html"!==(o=I(r));)t.push(o),r=r.parentNode;return t.reverse().join(" > ")};function U(t){if(j.circle){let e=t.target.className.split(/\s+/),n=M(t.target);return n=1===e.length||2===e.length&&""===e[0]?n.replace(/\.\.bombayjs-circle-active/,""):n.replace(/\.bombayjs-circle-active/,""),window.parent.postMessage({t:"setElmPath",path:n,page:j.page},"*"),void t.stopPropagation()}var n;try{n=t.target}catch(e){n="<unknown>"}if("INPUT"!==n.nodeName&&"TEXTAREA"!==n.nodeName&&0!==n.length){var o={type:"ui.click",data:{path:M(n),pageX:t.pageX,pageY:t.pageY,message:""}};const r=e.ignore.ignoreBehaviorEles.some(e=>o.data.path.includes(e));if(!o.data.path||r)return;let a=L(),i=Object.assign(Object.assign({},a),{t:"behavior",behavior:o});if(e.reportUrlMultiple){if(j.reportCache.push(i),localStorage.setItem("bombay-cache",JSON.stringify(j.reportCache)),j.reportCache.length>=e.maxCacheLength){x(JSON.parse(JSON.stringify(j.reportCache))),j.reportCache=[],localStorage.removeItem("bombay-cache")}}else x(i)}}function B(t){var n;try{n=t.target}catch(e){n="<unknown>"}if("INPUT"!==n.nodeName&&"TEXTAREA"!==n.nodeName)return;var o={type:"ui.blur",data:{path:M(n),pageX:t.pageX,pageY:t.pageY,message:n.value}};const r=e.ignore.ignoreBehaviorEles.some(e=>o.data.path.includes(e));if(!o.data.path||!o.data.message||r)return;let a=L();x(Object.assign(Object.assign({},a),{t:"behavior",behavior:o}))}function D(e){let t=L();x(Object.assign(Object.assign({},t),{t:"behavior",behavior:e}))}const H=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","domComplete","loadEventStart","","msFirstPaint","secureConnectionStart"];function X(t){let n=e.enableSPA?l(location.hash.toLowerCase()):location.pathname.toLowerCase();n&&J(n,!1)}function $(t){let n=e.enableSPA?l(t.detail.toLowerCase()):t.detail.toLowerCase();n&&J(n,!1)}function J(t,n){!n&&j.page===t&&j.sBegin>Date.now()-100||(!n&&q(),w&&window.parent.postMessage({t:"setPage",href:location.href,page:t},"*"),function(e){j.page=e}(t),j.sid=r(),j.sBegin=Date.now(),function(){if(!e.autoSendPv)return;let t=L();e.ignore.ignorePvs.includes(t.page)||x(Object.assign(Object.assign({},t),{t:"pv",dt:document.title,dl:encodeURIComponent(location.href),dr:encodeURIComponent(document.referrer),dpr:window.devicePixelRatio,de:document.charset}))}())}function q(){let e=j._health.errcount?0:1,t=L(),n=Object.assign(Object.assign(Object.assign({},t),j._health),{t:"health",healthy:e,stay:Date.now()-j.sBegin});j._health={errcount:0,apisucc:0,apifail:0},x(n)}function F(t){if(!e.ignore.ignoreErrors.includes(t.type)){switch(t.type){case"error":t instanceof ErrorEvent?function(e){let t=L(),n=e.name||"CustomError",o=e.message||"",r=e.error.stack||"";x(Object.assign(Object.assign({},t),{t:"error",st:"caughterror",cate:n,msg:A(o),detail:A(r),file:A(e.filename)||"",line:e.lineno||"",col:e.colno||""}))}(t):function(t){let n=L(),o=t.target;if(e.ignore.ignoreResources.some(e=>o.src.includes(e)))return;x(Object.assign(Object.assign({},n),{t:"error",st:"resource",msg:encodeURIComponent(o.outerHTML),file:A(encodeURIComponent(o.src)),stack:o.localName.toUpperCase()}))}(t);break;case"unhandledrejection":!function(e){let t=L();x(Object.assign(Object.assign({},t),{t:"error",st:"promise",msg:A(e.reason)}))}(t)}O("error")}}function V(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;let t=L(),o=Object.assign(Object.assign({},t),{dom:0,load:0,t:"res",res:[]});var r=e.timing||{},a=e.getEntriesByType("resource")||[];if("function"==typeof window.PerformanceNavigationTiming){var s=e.getEntriesByType("navigation")[0];s&&(r=s)}if(i({dom:[10,8],load:[14,1]},function(e,t){var n=r[H[e[1]]],a=r[H[e[0]]];if(void 0!==n&&void 0!==a){var i=Math.round(a-n);i>=0&&i<36e5&&(o[t]=i)}}),a=a.filter(e=>{return!(v(n("ignore").ignoreApis,t=>e.name.indexOf(t)>-1)>-1)}),m()){var c=[];i(a,function(e){c.push({connectEnd:e.connectEnd,connectStart:e.connectStart,domainLookupEnd:e.connectStart,domainLookupStart:e.domainLookupStart,duration:e.duration,entryType:e.entryType,fetchStart:e.fetchStart,initiatorType:e.initiatorType,name:e.name,redirectEnd:e.redirectEnd,redirectStart:e.redirectStart,responseEnd:e.responseEnd,responseStart:e.responseStart,startTime:e.startTime})}),a=c}o.res=a,x(o)}function Y(e,t,o,r,a,i){if(!e)return void g("[retcode] api is null");O("api",t);let s=A(a),c=encodeURIComponent(e),d=L(),l=Object.assign(Object.assign({},d),{t:"api",url:c,success:t,time:o,code:r,msg:s});v(n("ignore").ignoreApis,e=>c.indexOf(e)>-1)>-1||x(l)}function W(e){var t=document.getElementsByClassName(_);if(t.length>0)for(var n=0;n<t.length;n++)t[n].className=t[n].className.replace(/ bombayjs-circle-active/g,"");e.target.className+=` ${_}`}function z(){!function(){var e=`.${_}{border: #ff0000 2px solid;}`,t=document.createElement("style");t.type="text/css",t.id=N;try{t.appendChild(document.createTextNode(e))}catch(n){t.styleSheet.cssText=e}document.getElementsByTagName("head")[0].appendChild(t)}(),j.cssInserted=!0,j.circle=!0,s("mouseover",W)}function G(){var e;(e=document.getElementById(N)).parentNode.removeChild(e),j.cssInserted=!1,j.circle=!1,c("mouseover",W)}function K(e){e.data&&e.data.t&&("setCircle"===e.data.t?Boolean(e.data.v)?z():G():"back"===e.data.t?window.history.back():"forward"===e.data.t&&window.history.forward())}function Q(){const t=e.sendMill,n=Date.now()-j.lastTime;if(n>e.offlineTime)j.lastTime=Date.now();else if(n>t){j.lastTime=Date.now();let e=L();x(Object.assign(Object.assign({},e),{t:"duration",duration_ms:n}))}}function Z(t){var n=history[t];"function"==typeof n&&(history[t]=function(o,r,a){!window.__bb_onpopstate_&&(window.__bb_onpopstate_=window.onpopstate,window.addEventListener("popstate",function(){let t=e.enableSPA?l(location.hash.toLowerCase()):location.pathname.toLowerCase();J(t,!1)}));var i=1===arguments.length?[arguments[0]]:Array.apply(null,arguments),s=location.href,c=n.apply(history,i);if(!a||"string"!=typeof a)return c;if(a===s)return c;try{var d=s.split("#"),p=a.split("#"),h=u(d[0]),v=u(p[0]),m=d[1]&&d[1].replace(/^\/?(.*)/,"$1"),w=p[1]&&p[1].replace(/^\/?(.*)/,"$1");h!==v?f("historystatechanged",v):m!==w&&f("historystatechanged",w)}catch(e){g("[retcode] error in "+t+": "+e)}return c},history[t].toString=p(t))}function ee(){!function(){if("function"==typeof window.fetch){var t=window.fetch;window.__oFetch_=t,window.fetch=function(n,o){var r=1===arguments.length?[arguments[0]]:Array.apply(null,arguments),a=Date.now(),i=(n&&"string"!=typeof n?n.url:n)||"",s=u(i);return s?t.apply(window,r).then(function(t){var n=t.clone(),o=n.headers;if(o&&"function"==typeof o.get){var r=o.get("content-type");if(r&&!/(text)|(json)/.test(r))return t}var i=Date.now()-a;return n.text().then(function(t){n.ok?Y(s,!0,i,status,t.substr(0,e.maxLength)||""):Y(s,!1,i,status,t.substr(0,e.maxLength)||"")}),t}):t.apply(window,r)}}}(),function(){if("function"==typeof window.XMLHttpRequest){var t=0,n="",o=window.XMLHttpRequest;window.__oXMLHttpRequest_=o,window.XMLHttpRequest=function(r){var a=new o(r);if(!a.addEventListener)return a;var i=a.open,s=a.send;return a.open=function(e,t){var o=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);n=u(t=t),i.apply(a,o)},a.send=function(){t=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);s.apply(a,e)},d(a,"readystatechange",function(){if(n&&4===a.readyState){var o=Date.now()-t;if(a.status>=200&&a.status<=299){var r=a.status||200;if("function"==typeof a.getResponseHeader){var i=a.getResponseHeader("Content-Type");if(i&&!/(text)|(json)/.test(i))return}Y(n,!0,o,r,a.responseText.substr(0,e.maxLength)||"")}else{var r=a.status||"FAILED";Y(n,!1,o,r,a.responseText.substr(0,e.maxLength)||"")}}},!1),a}}}()}export default class{constructor(e,t){this.init(e)}init(n){var{Vue:o}=n,r=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&(n[o[r]]=e[o[r]])}return n}(n,["Vue"]);if(r&&!r.token)throw Error("请输入一个token");o&&this.addListenVueError(o),t(r),J(e.enableSPA?l(location.hash.toLowerCase()):location.pathname.toLowerCase(),!0),e.isPage&&this.sendPerf(),e.enableSPA&&this.addListenRouterChange(),e.isError&&this.addListenJs(),e.isAjax&&this.addListenAjax(),e.isRecord&&this.addRrweb(),e.isBehavior&&this.addListenBehavior(),e.isResource&&this.sendResource(),window.__bb=this,this.addListenUnload(),s("message",K),j.circle&&z()}handleCustomizeReport(t){if(!e.token)throw Error("请输入一个合法token");!function(e){if(!e.t)throw Error("行为类型不能为空");let t=L();x(Object.assign(Object.assign({},t),e))}(t)}setUserInfo(e){t({user:e})}sendPerf(){!function(){const e=window.performance;if(!e||"object"!=typeof e)return;let t={dns:0,tcp:0,ssl:0,ttfb:0,trans:0,dom:0,res:0,firstbyte:0,fpt:0,tti:0,ready:0,load:0},n=e.timing||{},o=Date.now(),r=1,a=setInterval(()=>{if(n.loadEventEnd){if(clearInterval(a),"function"==typeof window.PerformanceNavigationTiming){var s=e.getEntriesByType("navigation")[0];s&&(n=s,r=2)}i({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[13,10],res:[8,6],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,o){var a=n[H[e[1]]],i=n[H[e[0]]],s=Math.round(i-a);(2===r||void 0!==a&&void 0!==i)&&("dom"===o&&(s=Math.round(i-a)),s>=0&&s<36e5&&(t[o]=s))});var c=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection,d=e.navigation||{type:void 0};t.ct=c?c.effectiveType||c.type:"";var l=c&&(c.downlink||c.downlinkMax||c.bandwidth)||null;if((l=l>999?999:l)&&(t.bandwidth=l),t.navtype=1===d.type?"Reload":"Other",1===r&&n[H[16]]>0&&n[H[1]]>0){var u=n[H[16]]-n[H[1]];u>=0&&u<36e5&&(t.fpt=u)}1===r&&n[H[1]]>0?t.begin=n[H[1]]:2===r&&t.load>0?t.begin=o-t.load:t.begin=o;let p=L();x(Object.assign(Object.assign(Object.assign(Object.assign({},p),{t:"perf"}),t),n))}},50)}()}sendResource(){"complete"===window.document.readyState?V():this.addListenResource()}addListenResource(){s("load",V)}addListenBehavior(){!function(){if(window&&window.console)for(var t=e.behavior.console,n=0;t.length;n++){var o=t[n],r=window.console[o];if(!window.console[o])return;!function(e,t){window.console[e]=function(){var n=Array.prototype.slice.apply(arguments);D({type:"console",data:{level:e,message:JSON.stringify(n,b())}}),t&&t.apply(null,n)}}(o,r)}}(),e.behavior.click&&this.addListenClick()}addListenClick(){s("click",U),s("blur",B),e.isCountStayTime&&(s("click",Q),s("blur",Q))}addListenRouterChange(){Z("pushState"),Z("replaceState"),s("hashchange",X),s("historystatechanged",$)}addListenVueError(e){e&&e.config&&(e.config.errorHandler,e.config.errorHandler=function(e,t,n){console.error(e),function(e,t,n){let o=L();x(Object.assign(Object.assign({},o),{t:"error",st:"vue_error",msg:A(e),file:"",detail:JSON.stringify(n,b())}))}(e,0,n)})}addListenJs(){s("error",F),s("unhandledrejection",F)}addListenAjax(){ee()}addListenUnload(){s("beforeunload",q),this.destroy()}addRrweb(){}removeListenRouterChange(){c("hashchange",X),c("historystatechanged",$)}removeListenJs(){c("error",F),c("unhandledrejection",F)}removeListenResource(){c("beforeunload",q)}removeListenAjax(){}removeListenUnload(){c("load",V)}removeRrweb(){}sum(e,t){!function(e,t=1){let n=L(),o=h(e);x(Object.assign(Object.assign(Object.assign({},n),o),{t:"sum",val:t}))}(e,t)}avg(e,t){!function(e,t=1){let n=L(),o=h(e);x(Object.assign(Object.assign(Object.assign({},n),o),{t:"avg",val:t}))}(e,t)}msg(t){!function(t){let n=L(),o=h(t);x(Object.assign(Object.assign({},n),{t:"msg",group:o.group,msg:A(o.key.substr(0,e.maxLength))}))}(t)}api(e,t,n,o,r){Y(e,t,n,o,r)}destroy(){e.enableSPA&&this.removeListenRouterChange(),e.isError&&this.removeListenJs(),e.isAjax&&this.removeListenAjax(),e.isRecord&&this.removeRrweb(),e.isResource&&this.removeListenResource(),this.removeListenResource()}}
